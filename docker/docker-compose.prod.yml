# Fred — Production Docker Compose (Coolify / Hetzner)
# Extends the base compose file with production overrides
# Usage: docker compose -f docker/docker-compose.yml -f docker/docker-compose.prod.yml up -d

services:
  postgres:
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB}
    ports: []  # No exposed ports in production
    volumes:
      - postgres_data:/var/lib/postgresql/data
      # Remove init-scripts mount — use migrations instead

  redis:
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD} --maxmemory 512mb --maxmemory-policy allkeys-lru
    ports: []  # No exposed ports in production

  api:
    build:
      context: ..
      dockerfile: docker/Dockerfile.api
      target: production
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      JWT_SECRET: ${JWT_SECRET}
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
      PORT: 3001
    ports:
      - "3001:3001"
    volumes: []  # No source mounts in production
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  workers:
    build:
      context: ..
      dockerfile: docker/Dockerfile.workers
      target: production
    environment:
      NODE_ENV: production
      DATABASE_URL: ${DATABASE_URL}
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis:6379
      ENCRYPTION_KEY: ${ENCRYPTION_KEY}
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3

  web:
    build:
      context: ..
      dockerfile: docker/Dockerfile.web
      target: production
    environment:
      NODE_ENV: production
      NEXT_PUBLIC_API_URL: ${PUBLIC_API_URL}
      NEXT_PUBLIC_WS_URL: ${PUBLIC_WS_URL}
    ports:
      - "3000:3000"
    volumes: []
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: "1.0"

  n8n:
    environment:
      N8N_HOST: ${N8N_HOST}
      N8N_PROTOCOL: https
      WEBHOOK_URL: ${N8N_WEBHOOK_URL}
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      N8N_ENCRYPTION_KEY: ${N8N_ENCRYPTION_KEY}
      FRED_API_URL: http://api:3001
      FRED_API_KEY: ${FRED_N8N_API_KEY}
    ports:
      - "5678:5678"

  bull-board:
    # Disable in production or protect behind auth
    profiles:
      - monitoring
